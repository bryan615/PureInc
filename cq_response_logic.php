<?php 
$sql = "
SELECT * FROM (SELECT m.is_valid,rv.is_dismissed,rv.id as `lead_id`,rv.qualified,rv.member_id,m.type,rv.partner,m.first_qa_date,m.final_qa_date,m.email as `email`,tcase(m.first_name)  AS `first_name`,tcase(m.last_name)  AS `last_name`,tcase(m.address1)  AS `address`,tcase(m.city)  AS `city`,m.state  AS `state`,m.zip as `zip`,m.country  AS `country`,tcase(m.company_name)  AS `company`,m.phone as `phone`,m.job_function  AS `job_function`,m.job_area  AS `job_area`,m.company_size AS `company_size`,tcase(m.industry) AS `industry`,tcase(m.job_level) AS `job_level`,m.company_revenue AS `company_revenue`,tcase(m.job_title) AS `job_title`,r.name as `lead_resource`,rv.resource_id  as `resource_id`,rv.created_at  as `created_at`,rv.source  as `source`,rv.updated_at  as `updated_at`,  m.phone_verified  FROM resource_views rv INNER JOIN members m ON rv.member_id = m.id INNER JOIN resources r ON rv.resource_id = r.id WHERE rv.updated_at >= [DATE] AND rv.returned != 1 AND rv.campaign_id = 13876 ORDER BY rv.member_id desc,rv.created_at asc) AS leads WHERE leads.type = 'M' AND leads.is_valid = 1 AND leads.phone_verified = 1 AND ( ((leads.job_level IN ('C-Level')) AND ( leads.`country` IN ('US')) AND (leads.company_size IN ('1 to 9','10 to 24','25-49','50-99','100-249','250-499','500-999','1,000-4,999','5,000-9,999','10,000-49,999','50K-100K','>100K')) 
AND ((leads.`job_function` = 'Operations' AND leads.`job_area` IN ('General Operations'))) AND (leads.industry IN ('Aerospace and Aviation','Agriculture and Mining','Business Services','Computers and Electronics','Construction and Real Estate','Education','Energy, Raw Materials and Utilities','Finance','Food and Beverage','Government','Healthcare, Pharmaceuticals and Biotech','Insurance','Legal','Manufacturing','Marketing, Advertising and Public Relations','Media, Entertainment and Publishing','Non-Profit','Retail','Software, Internet and Technology','Telecommunications','Transportation','Travel, Hotel, Restaurant and Recreation','Wholesale and Distribution')) AND ((leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%operating%' AND leads.`job_title` LIKE '%officer%') OR leads.`job_title` LIKE '%coo%') ) AND (leads.`job_title` NOT LIKE '%junior%' AND leads.`job_title` NOT LIKE '%assistant%' AND leads.`job_title` NOT LIKE '%intern%')  OR ((leads.job_level IN ('C-Level','VP Level','Director Level','Manager Level','Individual Contributor','Other')) AND ( leads.`country` IN ('US')) AND (leads.company_size IN ('1 to 9','10 to 24','25-49','50-99','100-249','250-499','500-999','1,000-4,999','5,000-9,999','10,000-49,999','50K-100K','>100K')) 
AND ((leads.`job_function` = 'Information Technology' AND leads.`job_area` IN ('Data Science, Reporting, and Analytics','IT Management General','IT and Software Architecture','Project Managers & Business Analysts'))) AND (leads.industry IN ('Aerospace and Aviation','Agriculture and Mining','Business Services','Computers and Electronics','Construction and Real Estate','Education','Energy, Raw Materials and Utilities','Finance','Food and Beverage','Government','Healthcare, Pharmaceuticals and Biotech','Insurance','Legal','Manufacturing','Marketing, Advertising and Public Relations','Media, Entertainment and Publishing','Non-Profit','Retail','Software, Internet and Technology','Telecommunications','Transportation','Travel, Hotel, Restaurant and Recreation','Wholesale and Distribution'))) AND (leads.`job_title` NOT LIKE '%junior%' AND leads.`job_title` NOT LIKE '%assistant%' AND leads.`job_title` NOT LIKE '%intern%')  OR ((leads.job_level IN ('C-Level')) AND ( leads.`country` IN ('US')) AND (leads.company_size IN ('1 to 9','10 to 24','25-49','50-99','100-249','250-499','500-999','1,000-4,999','5,000-9,999','10,000-49,999','50K-100K','>100K')) 
AND ((leads.`job_function` = 'Product Management and Innovation' AND leads.`job_area` IN ('Product Management'))) AND (leads.industry IN ('Aerospace and Aviation','Agriculture and Mining','Business Services','Computers and Electronics','Construction and Real Estate','Education','Energy, Raw Materials and Utilities','Finance','Food and Beverage','Government','Healthcare, Pharmaceuticals and Biotech','Insurance','Legal','Manufacturing','Marketing, Advertising and Public Relations','Media, Entertainment and Publishing','Non-Profit','Retail','Software, Internet and Technology','Telecommunications','Transportation','Travel, Hotel, Restaurant and Recreation','Wholesale and Distribution')) AND ((leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%product%' AND leads.`job_title` LIKE '%officer%' AND leads.`job_title` LIKE '%%') OR leads.`job_title` LIKE '%cpo%') ) AND (leads.`job_title` NOT LIKE '%junior%' AND leads.`job_title` NOT LIKE '%assistant%' AND leads.`job_title` NOT LIKE '%intern%')  OR ((leads.job_level IN ('C-Level')) AND ( leads.`country` IN ('US')) AND (leads.company_size IN ('1 to 9','10 to 24','25-49','50-99','100-249','250-499','500-999','1,000-4,999','5,000-9,999','10,000-49,999','50K-100K','>100K')) 
AND ((leads.`job_function` = 'General Management' AND leads.`job_area` IN ('General Management','General Management'))) AND (leads.industry IN ('Aerospace and Aviation','Agriculture and Mining','Business Services','Computers and Electronics','Construction and Real Estate','Education','Energy, Raw Materials and Utilities','Finance','Food and Beverage','Government','Healthcare, Pharmaceuticals and Biotech','Insurance','Legal','Manufacturing','Marketing, Advertising and Public Relations','Media, Entertainment and Publishing','Non-Profit','Retail','Software, Internet and Technology','Telecommunications','Transportation','Travel, Hotel, Restaurant and Recreation','Wholesale and Distribution')) AND ((leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%strategy%' AND leads.`job_title` LIKE '%officer%') OR leads.`job_title` LIKE '%cso%' OR (leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%administrative%' AND leads.`job_title` LIKE '%officer%') OR leads.`job_title` LIKE '%cao%' OR leads.`job_title` LIKE '%president%' OR leads.`job_title` LIKE '%principal%' OR (leads.`job_title` LIKE '%vice%' AND leads.`job_title` LIKE '%chairman%')) ) AND (leads.`job_title` NOT LIKE '%junior%' AND leads.`job_title` NOT LIKE '%assistant%' AND leads.`job_title` NOT LIKE '%intern%')  OR ((leads.job_level IN ('C-Level')) AND ( leads.`country` IN ('US')) AND (leads.company_size IN ('1 to 9','10 to 24','25-49','50-99','100-249','250-499','500-999','1,000-4,999','5,000-9,999','10,000-49,999','50K-100K','>100K')) 
AND ((leads.`job_function` = 'Marketing' AND leads.`job_area` IN ('General Marketing'))) AND (leads.industry IN ('Aerospace and Aviation','Agriculture and Mining','Business Services','Computers and Electronics','Construction and Real Estate','Education','Energy, Raw Materials and Utilities','Finance','Food and Beverage','Government','Healthcare, Pharmaceuticals and Biotech','Insurance','Legal','Manufacturing','Marketing, Advertising and Public Relations','Media, Entertainment and Publishing','Non-Profit','Retail','Software, Internet and Technology','Telecommunications','Transportation','Travel, Hotel, Restaurant and Recreation','Wholesale and Distribution')) AND ((leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%digital%' AND leads.`job_title` LIKE '%officer%') OR leads.`job_title` LIKE '%cdo%') ) AND (leads.`job_title` NOT LIKE '%junior%' AND leads.`job_title` NOT LIKE '%assistant%' AND leads.`job_title` NOT LIKE '%intern%')  OR ((leads.job_level IN ('C-Level')) AND ( leads.`country` IN ('US')) AND (leads.company_size IN ('1 to 9','10 to 24','25-49','50-99','100-249','250-499','500-999','1,000-4,999','5,000-9,999','10,000-49,999','50K-100K','>100K')) AND ((leads.`job_function` = 'Finance' AND leads.`job_area` IN ('Accounting','Compliance and Risk','General Finance'))) AND (leads.industry IN ('Aerospace and Aviation','Agriculture and Mining','Business Services','Computers and Electronics','Construction and Real Estate','Education','Energy, Raw Materials and Utilities','Finance','Food and Beverage','Government','Healthcare, Pharmaceuticals and Biotech','Insurance','Legal','Manufacturing','Marketing, Advertising and Public Relations','Media, Entertainment and Publishing','Non-Profit','Retail','Software, Internet and Technology','Telecommunications','Transportation','Travel, Hotel, Restaurant and Recreation','Wholesale and Distribution')) AND ((leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%audit%' AND leads.`job_title` LIKE '%officer%') OR leads.`job_title` LIKE '%cao%' OR (leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%compliance%' AND leads.`job_title` LIKE '%officer%') OR leads.`job_title` LIKE '%cco%' OR (leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%financial%' AND leads.`job_title` LIKE '%officer%' AND leads.`job_title` LIKE '%%') OR leads.`job_title` LIKE '%cfo%' OR (leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%information%' AND leads.`job_title` LIKE '%risk%' AND leads.`job_title` LIKE '%officer%') OR leads.`job_title` LIKE '%ciro%' OR (leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%risk%' AND leads.`job_title` LIKE '%officer%') OR leads.`job_title` LIKE '%cro%') ) AND (leads.`job_title` NOT LIKE '%junior%' AND leads.`job_title` NOT LIKE '%assistant%' AND leads.`job_title` NOT LIKE '%intern%')  OR ((leads.job_level IN ('C-Level')) AND ( leads.`country` IN ('US')) AND (leads.company_size IN ('1 to 9','10 to 24','25-49','50-99','100-249','250-499','500-999','1,000-4,999','5,000-9,999','10,000-49,999','50K-100K','>100K')) 
AND ((leads.`job_function` = 'Medical & Health' AND leads.`job_area` IN ('General (yes) Management'))) AND (leads.industry IN ('Aerospace and Aviation','Agriculture and Mining','Business Services','Computers and Electronics','Construction and Real Estate','Education','Energy, Raw Materials and Utilities','Finance','Food and Beverage','Government','Healthcare, Pharmaceuticals and Biotech','Insurance','Legal','Manufacturing','Marketing, Advertising and Public Relations','Media, Entertainment and Publishing','Non-Profit','Retail','Software, Internet and Technology','Telecommunications','Transportation','Travel, Hotel, Restaurant and Recreation','Wholesale and Distribution')) AND ((leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%medical%' AND leads.`job_title` LIKE '%officer%') OR leads.`job_title` LIKE '%cmo%') ) AND (leads.`job_title` NOT LIKE '%junior%' AND leads.`job_title` NOT LIKE '%assistant%' AND leads.`job_title` NOT LIKE '%intern%')  OR ((leads.job_level IN ('C-Level')) AND ( leads.`country` IN ('US')) AND (leads.company_size IN ('1 to 9','10 to 24','25-49','50-99','100-249','250-499','500-999','1,000-4,999','5,000-9,999','10,000-49,999','50K-100K','>100K')) 
AND ((leads.`job_function` = 'Human Resources' AND leads.`job_area` IN ('General'))) AND (leads.industry IN ('Aerospace and Aviation','Agriculture and Mining','Business Services','Computers and Electronics','Construction and Real Estate','Education','Energy, Raw Materials and Utilities','Finance','Food and Beverage','Government','Healthcare, Pharmaceuticals and Biotech','Insurance','Legal','Manufacturing','Marketing, Advertising and Public Relations','Media, Entertainment and Publishing','Non-Profit','Retail','Software, Internet and Technology','Telecommunications','Transportation','Travel, Hotel, Restaurant and Recreation','Wholesale and Distribution')) AND ((leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%people%' AND leads.`job_title` LIKE '%officer%')) ) AND (leads.`job_title` NOT LIKE '%junior%' AND leads.`job_title` NOT LIKE '%assistant%' AND leads.`job_title` NOT LIKE '%intern%')  OR ((leads.job_level IN ('C-Level')) AND ( leads.`country` IN ('US')) AND (leads.company_size IN ('1 to 9','10 to 24','25-49','50-99','100-249','250-499','500-999','1,000-4,999','5,000-9,999','10,000-49,999','50K-100K','>100K')) 
AND ((leads.`job_function` = 'Information Technology' AND leads.`job_area` IN ('IT Management General'))) AND (leads.industry IN ('Aerospace and Aviation','Agriculture and Mining','Business Services','Computers and Electronics','Construction and Real Estate','Education','Energy, Raw Materials and Utilities','Finance','Food and Beverage','Government','Healthcare, Pharmaceuticals and Biotech','Insurance','Legal','Manufacturing','Marketing, Advertising and Public Relations','Media, Entertainment and Publishing','Non-Profit','Retail','Software, Internet and Technology','Telecommunications','Transportation','Travel, Hotel, Restaurant and Recreation','Wholesale and Distribution')) AND ((leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%information%' AND leads.`job_title` LIKE '%officer%') OR leads.`job_title` LIKE '%cio%' OR (leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%information%' AND leads.`job_title` LIKE '%security%' AND leads.`job_title` LIKE '%officer%') OR leads.`job_title` LIKE '%ciso%' OR (leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%innovation%' AND leads.`job_title` LIKE '%officer%') OR (leads.`job_title` LIKE '%chief%' AND leads.`job_title` LIKE '%technology%' AND leads.`job_title` LIKE '%officer%') OR leads.`job_title` LIKE '%cto%') ) AND (leads.`job_title` NOT LIKE '%junior%' AND leads.`job_title` NOT LIKE '%assistant%' AND leads.`job_title` NOT LIKE '%intern%') )  AND (leads.company_revenue IN ('< $1 Million','$1-9 Million','$10-49 Million','$50 - 99 Million','$100 - 249 Million','$250 - 499 Million','$500 M - 1 Billion','>$1 Billion')) AND right(leads.`email`, length(leads.`email`)-INSTR(leads.`email`, '@')) NOT IN (SELECT `domain` FROM suppressed_domains WHERE campaign_id = 13876)
";

        
//$sql = str_replace(array("\t", "\r", "\n"), ' ', $sql);
//$sql = str_replace('  ', ' ', $sql);
    
$resp = array();
function recsSplit($sql, $layer) {
    
    global $resp;
    //preg_match_all("/\((([^()]*|(?R))*)\)/", $sql, $matches);
    preg_match_all("/\((([^()]*+)(?:(?R)(?2))*)\)/", $sql, $matches);
    if (count($matches) > 1) {
        for ($i = 0; $i < count($matches[1]); $i++) {
            if (is_string($matches[1][$i])) {
                if (strlen($matches[1][$i]) > 0) {

                    if (strpos($matches[1][$i], 'job_function') 
                        && strpos($matches[1][$i], 'job_area')
                        && $layer == 1
                    ) {
                        $resp[] = $matches[1][$i];
                    }

                    recsSplit($matches[1][$i], $layer + 1);
                }
            }
        }
    }

    return $resp;
}
$array = recsSplit($sql, 0);

$filt_arr = [];
foreach ($array as $i => $str) {
    $lvlone = explode("AND (", $str);
    foreach ($lvlone as $cond) {
        if (strpos($cond, 'job_function') && strpos($cond, 'job_area')) {
            $filt_arr[$i] = "AND (".$cond;
        }
    }
}


$retr = [];
foreach ($filt_arr as $i => $str) {

    $retr[$i]['string'] = $str;
    preg_match("/\'(.*?)\'/", $str, $func);
    $retr[$i]['job_function'] = $func[1];

    if (preg_match_all("/'[^']*'(?=[^(']*('[^']*'[^'(]*)*\))/", $str, $areas )) {
        $retr[$i]['job_area'] = $areas[0];
    }
    
}

print_r($retr);

//conditions